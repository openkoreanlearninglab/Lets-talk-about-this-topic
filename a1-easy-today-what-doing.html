<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korean Learning: Daily Conversation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&family=IBM+Plex+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nanum Gothic', sans-serif;
        }
        .vocab-popup {
            font-family: 'Nanum Gothic', sans-serif;
            z-index: 50;
            max-width: 320px;
            white-space: normal;
        }
        .highlight-general {
            font-weight: 700; /* font-bold */
            color: #374151; /* text-gray-700 */
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }
        .highlight-specific {
            font-weight: 800; /* font-extrabold */
            color: #059669; /* text-green-600 */
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }
        .highlight-general:hover, .highlight-specific:hover, .active-highlight {
            background-color: #d1fae5; /* green-100 */
            border-radius: 3px;
        }
        .vocab-highlight {
            background-color: #ecfdf5; /* green-50 */
            border-left: 4px solid #10b981; /* green-500 */
            transition: background-color 0.3s ease-in-out;
        }
        .script-highlight {
            background-color: #fefce8; /* yellow-50 */
            border-radius: 4px;
            transition: background-color 0.2s ease-in-out;
        }

        /* --- í™”ë©´ í¬ê¸° ì¡°ì •ì„ ìœ„í•œ ë¯¸ë””ì–´ ì¿¼ë¦¬ --- */
        .main-content-container {
            max-width: 24cm; /* ê¸°ë³¸ ìµœëŒ€ ë„ˆë¹„ */
            margin-left: auto;
            margin-right: auto;
            transition: max-width 0.3s ease-in-out, font-size 0.3s ease-in-out;
        }

        /* ë¸Œë¼ìš°ì € ì„¸ë¡œ ë†’ì´ê°€ 21.2cm ì´í•˜ì¼ ê²½ìš° */
        @media (max-height: 21.2cm) {
            html {
                font-size: 90%; /* ì „ì²´ ì½˜í…ì¸  ë¹„ìœ¨ ì¡°ì •ì„ ìœ„í•´ ê¸°ë³¸ ê¸€ì í¬ê¸° ì¶•ì†Œ */
            }
            .main-content-container {
                max-width: 15cm;
            }
        }

        /* ë¸Œë¼ìš°ì € ì„¸ë¡œ ë†’ì´ê°€ 16.5cm ì´í•˜ì¼ ê²½ìš° */
        @media (max-height: 16.5cm) {
            html {
                font-size: 80%; /* ì „ì²´ ì½˜í…ì¸  ë¹„ìœ¨ ì¡°ì •ì„ ìœ„í•´ ê¸°ë³¸ ê¸€ì í¬ê¸° ë” ì¶•ì†Œ */
            }
            .main-content-container {
                max-width: 10cm;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo, useCallback } = React;

        // --- Mock Translation API ---
        const mockApiTranslations = {
            translation_button_label: { en: 'Translate', es: 'Traducir', fr: 'Traduire', ja: 'ç¿»è¨³', ko: 'ë²ˆì—­' },
            translation_hide_button_label: { en: 'Hide', es: 'Ocultar', fr: 'Cacher', ja: 'éš ã™', ko: 'ìˆ¨ê¸°ê¸°' },
            term_trans_easy_korean: { en: "Let's talk in easy Korean", es: "Hablemos en coreano fÃ¡cil", fr: "Parlons en corÃ©en facile", ja: "ç°¡å˜ãªéŸ“å›½èªã§è©±ã—ã¾ã—ã‚‡ã†" },
            term_trans_podcast: { en: "podcast", es: "pÃ³dcast", fr: "podcast", ja: "ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ" },
            term_trans_today: { en: "today", es: "hoy", fr: "aujourd'hui", ja: "ä»Šæ—¥" },
            term_trans_what_are_you_doing: { en: "What are you doing?", es: "Â¿QuÃ© estÃ¡s haciendo?", fr: "Qu'est-ce que tu fais?", ja: "ä½•ã‚’ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ" },
            term_trans_meet_friend: { en: "to meet a friend", es: "encontrarse con un amigo", fr: "rencontrer un ami", ja: "å‹é”ã«ä¼šã†" },
            term_trans_together: { en: "together", es: "juntos", fr: "ensemble", ja: "ä¸€ç·’ã«" },
            term_trans_eat: { en: "to eat", es: "comer", fr: "manger", ja: "é£Ÿã¹ã‚‹" },
            term_trans_watch_movie: { en: "to watch a movie", es: "ver una pelÃ­cula", fr: "regarder un film", ja: "æ˜ ç”»ã‚’è¦‹ã‚‹" },
            term_trans_sounds_fun: { en: "That sounds fun!", es: "Â¡Eso suena divertido!", fr: "Ã‡a a l'air amusant!", ja: "æ¥½ã—ãã†ã§ã™ã­ï¼" },
            term_trans_me_too: { en: "me too / I also", es: "yo tambiÃ©n", fr: "moi aussi", ja: "ç§ã‚‚" },
            term_trans_like: { en: "to like", es: "gustar", fr: "aimer", ja: "å¥½ãã§ã™" },
            term_trans_at_home: { en: "at home", es: "en casa", fr: "Ã  la maison", ja: "å®¶ã§" },
            term_trans_rest: { en: "to rest", es: "descansar", fr: "se reposer", ja: "ä¼‘ã‚€" },
            term_trans_listen_music: { en: "to listen to music", es: "escuchar mÃºsica", fr: "Ã©couter de la musique", ja: "éŸ³æ¥½ã‚’è´ã" },
            term_trans_read_book: { en: "to read a book", es: "leer un libro", fr: "lire un livre", ja: "æœ¬ã‚’èª­ã‚€" },
            term_trans_tomorrow: { en: "tomorrow", es: "maÃ±ana", fr: "demain", ja: "æ˜æ—¥" },
            term_trans_have_plans: { en: "I have plans / an appointment", es: "Tengo planes / una cita", fr: "J'ai des projets / un rendez-vous", ja: "äºˆå®šãŒã‚ã‚Šã¾ã™" },
            term_trans_go_shopping_mall: { en: "to go to the shopping mall", es: "ir al centro comercial", fr: "aller au centre commercial", ja: "ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ«ã«è¡Œã" },
            term_trans_buy_clothes: { en: "to buy clothes", es: "comprar ropa", fr: "acheter des vÃªtements", ja: "æœã‚’è²·ã†" },
            term_trans_are_shopping: { en: "Oh, you are shopping.", es: "Oh, estÃ¡s de compras.", fr: "Oh, tu fais du shopping.", ja: "ã‚ã‚ã€è²·ã„ç‰©ã‚’ã—ã¦ã„ã‚‹ã‚“ã§ã™ã­ã€‚" },
            term_trans_thats_right: { en: "that's right", es: "asÃ­ es", fr: "c'est exact", ja: "ãã®é€šã‚Šã§ã™" },
            term_trans_on_sunday: { en: "on Sunday", es: "el domingo", fr: "le dimanche", ja: "æ—¥æ›œæ—¥ã«" },
            term_trans_in_evening: { en: "in the evening", es: "por la noche", fr: "le soir", ja: "å¤•æ–¹ã«" },
            term_trans_cook: { en: "to cook", es: "cocinar", fr: "cuisiner", ja: "æ–™ç†ã™ã‚‹" },
            term_trans_really: { en: "Really?", es: "Â¿De verdad?", fr: "Vraiment?", ja: "æœ¬å½“ã§ã™ã‹ï¼Ÿ" },
            term_trans_cook_something: { en: "to cook (something)", es: "cocinar (algo)", fr: "cuisiner (quelque chose)", ja: "æ–™ç†ã‚’ã™ã‚‹" },
            term_trans_sometimes: { en: "sometimes", es: "a veces", fr: "parfois", ja: "æ™‚ã€…" },
            term_trans_i_see: { en: "I see / Oh, I get it", es: "Ya veo / Ah, entiendo", fr: "Je vois / Oh, je comprends", ja: "ãªã‚‹ã»ã©" },
            term_trans_expressions_learned: { en: "the expressions (we) learned", es: "las expresiones que aprendimos", fr: "les expressions que nous avons apprises", ja: "å­¦ã‚“ã è¡¨ç¾" },
            term_trans_again: { en: "again", es: "otra vez", fr: "encore", ja: "ã¾ãŸ" },
            term_trans_shall_we_check: { en: "Shall we check/confirm?", es: "Â¿Verificamos/confirmamos?", fr: "VÃ©rifions-nous/confirmons-nous?", ja: "ç¢ºèªã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ" },
            term_trans_thats_all: { en: "That's all (for now).", es: "Eso es todo (por ahora).", fr: "C'est tout (pour le moment).", ja: "ã“ã“ã¾ã§ã§ã™ã€‚" },
        };

        const mockTranslateApi = (key, targetLang) => {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const translations = mockApiTranslations[key];
                    if (translations) {
                        resolve(translations[targetLang] || translations['en'] || key);
                    } else {
                        resolve(key);
                    }
                }, 100);
            });
        };

        const useTranslation = () => {
            const [lang, setLang] = useState('en');
            useEffect(() => {
                const browserLang = navigator.language.split('-')[0];
                setLang(browserLang === 'ko' ? 'en' : browserLang);
            }, []);
            const t = useCallback(async (key) => await mockTranslateApi(key, lang), [lang]);
            const t_static = (key) => {
                if (!key || !mockApiTranslations[key]) return key;
                return mockApiTranslations[key][lang] || mockApiTranslations[key]['en'] || key;
            }
            return { t, lang, t_static };
        };


        const Icon = ({ children, className = 'w-6 h-6' }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const ThumbsUp = ({ className }) => <Icon className={className}><path d="M7 10v12"></path><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a2 2 0 0 1 3 1.88V5Z"></path></Icon>;
        const Sparkles = ({ className }) => <Icon className={className}><path d="m12 3-1.9 5.8-5.8 1.9 5.8 1.9L12 18l1.9-5.8 5.8-1.9-5.8-1.9L12 3z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></Icon>;
       
        const Spinner = ({ className }) => (
            <svg className={`animate-spin ${className}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );

        const ComprehensionQuiz = () => {
            const [selectedWords, setSelectedWords] = useState({});
            const [results, setResults] = useState({});
            const [translationsVisible, setTranslationsVisible] = useState({});
            const [hintsVisible, setHintsVisible] = useState({});

            const sentences = useMemo(() => [
                {
                    id: 1,
                    parts: ["ë¯¼í˜¸ ì”¨ëŠ” ", " ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”."],
                    blank: 'ì˜¤ëŠ˜',
                    answer: 'ì˜¤ëŠ˜',
                    bank: ['ì˜¤ëŠ˜', 'ë‚´ì¼', 'ì–´ì œ', 'ëª¨ë ˆ'],
                    explanation: "'ì˜¤ëŠ˜' means 'today'. Minho said he is meeting a friend today.",
                    eng: "Minho meets a friend today.",
                    wrongAnswerExplanations: {
                        'ë‚´ì¼': "'ë‚´ì¼' means 'tomorrow'.",
                        'ì–´ì œ': "'ì–´ì œ' means 'yesterday'.",
                        'ëª¨ë ˆ': "'ëª¨ë ˆ' means 'the day after tomorrow'."
                    }
                },
                {
                    id: 2,
                    parts: ["ë¯¼í˜¸ ì”¨ëŠ” ì¹œêµ¬í•˜ê³  ", "."],
                    blank: 'ì˜í™”ë¥¼ ë´ìš”',
                    answer: 'ì˜í™”ë¥¼ ë´ìš”',
                    bank: ['ì˜í™”ë¥¼ ë´ìš”', 'ì±…ì„ ì½ì–´ìš”', 'ìš´ë™í•´ìš”', 'ìš”ë¦¬í•´ìš”'],
                    explanation: "Minho said he watches a movie with his friend. 'ì˜í™”ë¥¼ ë³´ë‹¤' means 'to watch a movie'.",
                    eng: "Minho watches a movie with his friend.",
                    wrongAnswerExplanations: {
                        'ì±…ì„ ì½ì–´ìš”': "'ì±…ì„ ì½ë‹¤' means 'to read a book'.",
                        'ìš´ë™í•´ìš”': "'ìš´ë™í•˜ë‹¤' means 'to exercise'.",
                        'ìš”ë¦¬í•´ìš”': "'ìš”ë¦¬í•˜ë‹¤' means 'to cook'."
                    }
                },
                {
                    id: 3,
                    parts: ["ìœ ë‚˜ ì”¨ëŠ” ì˜¤ëŠ˜ ", "."],
                    blank: 'ì§‘ì—ì„œ ì‰¬ì–´ìš”',
                    answer: 'ì§‘ì—ì„œ ì‰¬ì–´ìš”',
                    bank: ['ì§‘ì—ì„œ ì‰¬ì–´ìš”', 'ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”', 'ì˜·ì„ ì‚¬ìš”', 'ìš´ë™í•´ìš”'],
                    explanation: "Yuna said she rests at home today. 'ì§‘ì—ì„œ ì‰¬ë‹¤' means 'to rest at home'.",
                    eng: "Yuna rests at home today.",
                    wrongAnswerExplanations: {
                        'ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”': "Yuna meets a friend tomorrow.",
                        'ì˜·ì„ ì‚¬ìš”': "Yuna buys clothes tomorrow.",
                        'ìš´ë™í•´ìš”': "Minho exercises."
                    }
                },
                {
                    id: 4,
                    parts: ["ìœ ë‚˜ ì”¨ëŠ” ì§‘ì—ì„œ ", "."],
                    blank: 'ìŒì•…ì„ ë“¤ì–´ìš”',
                    answer: 'ìŒì•…ì„ ë“¤ì–´ìš”',
                    bank: ['ìŒì•…ì„ ë“¤ì–´ìš”', 'ì˜í™”ë¥¼ ë´ìš”', 'ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”', 'ì˜·ì„ ì‚¬ìš”'],
                    explanation: "Yuna said she listens to music at home. 'ìŒì•…ì„ ë“£ë‹¤' means 'to listen to music'.",
                    eng: "Yuna listens to music at home.",
                    wrongAnswerExplanations: {
                        'ì˜í™”ë¥¼ ë´ìš”': "Minho watches a movie.",
                        'ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”': "She doesn't meet a friend at home.",
                        'ì˜·ì„ ì‚¬ìš”': "She doesn't buy clothes at home."
                    }
                },
                {
                    id: 5,
                    parts: ["ìœ ë‚˜ ì”¨ëŠ” ì§‘ì—ì„œ ", "."],
                    blank: 'ì±…ì„ ì½ì–´ìš”',
                    answer: 'ì±…ì„ ì½ì–´ìš”',
                    bank: ['ì±…ì„ ì½ì–´ìš”', 'ìš”ë¦¬í•´ìš”', 'ìš´ë™í•´ìš”', 'ì˜·ì„ ì‚¬ìš”'],
                    explanation: "Yuna said she reads a book at home. 'ì±…ì„ ì½ë‹¤' means 'to read a book'.",
                    eng: "Yuna reads a book at home.",
                    wrongAnswerExplanations: {
                        'ìš”ë¦¬í•´ìš”': "Yuna cooks sometimes.",
                        'ìš´ë™í•´ìš”': "Minho exercises.",
                        'ì˜·ì„ ì‚¬ìš”': "Yuna buys clothes tomorrow."
                    }
                },
                {
                    id: 6,
                    parts: ["ìœ ë‚˜ ì”¨ëŠ” ", " ì•½ì†ì´ ìˆì–´ìš”."],
                    blank: 'ë‚´ì¼',
                    answer: 'ë‚´ì¼',
                    bank: ['ë‚´ì¼', 'ì˜¤ëŠ˜', 'ì–´ì œ', 'ëª¨ë ˆ'],
                    explanation: "'ë‚´ì¼' means 'tomorrow'. Yuna said she has plans tomorrow.",
                    eng: "Yuna has plans tomorrow.",
                    wrongAnswerExplanations: {
                        'ì˜¤ëŠ˜': "Yuna rests at home today.",
                        'ì–´ì œ': "'ì–´ì œ' means 'yesterday'.",
                        'ëª¨ë ˆ': "'ëª¨ë ˆ' means 'the day after tomorrow'."
                    }
                },
                {
                    id: 7,
                    parts: ["ìœ ë‚˜ ì”¨ëŠ” ë‚´ì¼ ", "."],
                    blank: 'ì˜·ì„ ì‚¬ìš”',
                    answer: 'ì˜·ì„ ì‚¬ìš”',
                    bank: ['ì˜·ì„ ì‚¬ìš”', 'ì±…ì„ ì½ì–´ìš”', 'ìŒì•…ì„ ë“¤ì–´ìš”', 'ì˜í™”ë¥¼ ë´ìš”'],
                    explanation: "Yuna said she is going to the shopping mall to buy clothes tomorrow. 'ì˜·ì„ ì‚¬ë‹¤' means 'to buy clothes'.",
                    eng: "Yuna buys clothes tomorrow.",
                    wrongAnswerExplanations: {
                        'ì±…ì„ ì½ì–´ìš”': "Yuna reads a book today.",
                        'ìŒì•…ì„ ë“¤ì–´ìš”': "Yuna listens to music today.",
                        'ì˜í™”ë¥¼ ë´ìš”': "Minho watches a movie."
                    }
                },
                {
                    id: 8,
                    parts: ["ë¯¼í˜¸ ì”¨ëŠ” ì¼ìš”ì¼ì— ", "."],
                    blank: 'ìš´ë™í•´ìš”',
                    answer: 'ìš´ë™í•´ìš”',
                    bank: ['ìš´ë™í•´ìš”', 'ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”', 'ìŒì•…ì„ ë“¤ì–´ìš”', 'ì±…ì„ ì½ì–´ìš”'],
                    explanation: "Minho said he exercises on Sunday. 'ìš´ë™í•˜ë‹¤' means 'to exercise'.",
                    eng: "Minho exercises on Sunday.",
                    wrongAnswerExplanations: {
                        'ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”': "Minho meets a friend today.",
                        'ìŒì•…ì„ ë“¤ì–´ìš”': "Yuna listens to music.",
                        'ì±…ì„ ì½ì–´ìš”': "Yuna reads a book."
                    }
                },
                {
                    id: 9,
                    parts: ["ë¯¼í˜¸ ì”¨ëŠ” ì €ë…ì— ", "."],
                    blank: 'ìš”ë¦¬í•´ìš”',
                    answer: 'ìš”ë¦¬í•´ìš”',
                    bank: ['ìš”ë¦¬í•´ìš”', 'ìš´ë™í•´ìš”', 'ì˜í™”ë¥¼ ë´ìš”', 'ì˜·ì„ ì‚¬ìš”'],
                    explanation: "Minho said he cooks at home in the evening. 'ìš”ë¦¬í•˜ë‹¤' means 'to cook'.",
                    eng: "Minho cooks in the evening.",
                    wrongAnswerExplanations: {
                        'ìš´ë™í•´ìš”': "Minho exercises on Sunday.",
                        'ì˜í™”ë¥¼ ë´ìš”': "Minho watches a movie with his friend.",
                        'ì˜·ì„ ì‚¬ìš”': "Yuna buys clothes."
                    }
                },
                {
                    id: 10,
                    parts: ["ìœ ë‚˜ ì”¨ëŠ” ", " ìš”ë¦¬í•´ìš”."],
                    blank: 'ê°€ë”',
                    answer: 'ê°€ë”',
                    bank: ['ê°€ë”', 'ë§¤ì¼', 'ìì£¼', 'í•­ìƒ'],
                    explanation: "'ê°€ë”' means 'sometimes'. Yuna said she sometimes cooks.",
                    eng: "Yuna sometimes cooks.",
                    wrongAnswerExplanations: {
                        'ë§¤ì¼': "'ë§¤ì¼' means 'every day'.",
                        'ìì£¼': "'ìì£¼' means 'often'.",
                        'í•­ìƒ': "'í•­ìƒ' means 'always'."
                    }
                }
            ], []);
            
            const shuffledSentences = useMemo(() => {
                const shuffleArray = (array) => {
                    const newArray = [...array];
                    for (let i = newArray.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                    }
                    return newArray;
                };

                return sentences.map(sentence => ({
                    ...sentence,
                    bank: shuffleArray(sentence.bank)
                }));
            }, [sentences]);

            const handleWordSelect = (id, word) => {
                setSelectedWords(prev => ({...prev, [id]: word}));
                const isCorrect = sentences.find(s => s.id === id).answer === word;
                setResults(prev => ({...prev, [id]: isCorrect}));
            };

            const handleToggleTranslation = (id) => {
                setTranslationsVisible(prev => ({...prev, [id]: !prev[id]}));
            };

            const handleToggleHint = (id) => {
                if (results[id] === true) return;
                setHintsVisible(prev => ({...prev, [id]: !prev[id]}));
            };

            return (
                 <section>
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6 pb-3 border-b-2 border-gray-300">ë‚´ìš© í™•ì¸ í€´ì¦ˆ (Comprehension Quiz)</h2>
                    <div className="space-y-8">
                        {shuffledSentences.map((s, index) => (
                            <div key={s.id} className="p-6 border rounded-xl bg-white shadow-lg transition-all duration-300">
                                <p className="text-gray-700 font-bold text-lg mb-4">
                                    {index + 1}. ë‹¤ìŒ ë¹ˆì¹¸ì— ì•Œë§ì€ ë§ì„ ê³ ë¥´ì„¸ìš”. (Choose the correct word for the blank.)
                                </p>
                                <div className="p-4 bg-gray-100 rounded-lg text-left mb-3 text-gray-900 text-xl font-bold">
                                    {s.parts[0]}
                                    <span className="inline-block bg-yellow-200 text-blue-800 px-3 py-1 rounded-md font-extrabold mx-2">
                                        {hintsVisible[s.id] ? `[ ${s.blank} ]` : (selectedWords[s.id] || '___')}
                                    </span>
                                    {s.parts[1]}
                                    {results[s.id] === true && <ThumbsUp className="inline-block ml-2 text-green-500 w-6 h-6" />}
                                    {results[s.id] === false && <ThumbsUp className="inline-block ml-2 text-red-500 transform -scale-y-100 w-6 h-6" />}
                                </div>

                                {translationsVisible[s.id] && (
                                    <div className="text-gray-600 italic p-3 bg-gray-50 rounded-lg text-left mt-2 text-base">{s.eng}</div>
                                )}

                                <div className="text-left mb-4 flex gap-2">
                                    <button onClick={() => handleToggleTranslation(s.id)} className="text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-full transition duration-200">
                                        ë²ˆì—­ (Translation)
                                    </button>
                                    <button onClick={() => handleToggleHint(s.id)} className="text-xs bg-yellow-200 hover:bg-yellow-300 text-yellow-800 font-bold py-1 px-3 rounded-full transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled={results[s.id] === true}>
                                        íŒíŠ¸ (Hint)
                                    </button>
                                </div>
                    
                                <div className="flex justify-start flex-wrap gap-3">
                                    {s.bank.map(word => (
                                        <button
                                            key={word}
                                            onClick={() => handleWordSelect(s.id, word)}
                                            className={`px-4 py-2 rounded-lg text-lg font-bold transition-all transform hover:scale-105 shadow-md ${selectedWords[s.id] === word ? (results[s.id] ? 'bg-blue-600 text-white ring-2 ring-opacity-50 ring-blue-400' : 'bg-red-500 text-white ring-2 ring-red-300') : 'bg-white text-gray-800 hover:bg-gray-100 border'}`}
                                        >
                                            {word}
                                        </button>
                                    ))}
                                </div>
                                {results[s.id] !== undefined && (
                                    <div className={`mt-4 p-4 border-l-4 rounded-r-lg ${results[s.id] ? 'bg-green-50 border-green-400' : 'bg-red-50 border-red-400'}`}>
                                        <p className={`font-bold ${results[s.id] ? 'text-green-800' : 'text-red-800'} flex items-center gap-2 text-lg`}>
                                            {results[s.id] ? 'ì •ë‹µì…ë‹ˆë‹¤! (Correct!)' : 'ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”. (Try again.)'}
                                        </p>
                                        <p className="mt-2 text-gray-700 text-base">
                                            {results[s.id] ? s.explanation : s.wrongAnswerExplanations[selectedWords[s.id]]}
                                        </p>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </section>
            );
        };


        const InlineDefinition = ({ data, onClose, t, t_static }) => {
            const [translatedTerm, setTranslatedTerm] = useState('');
            const [showTranslation, setShowTranslation] = useState(false);

            useEffect(() => {
                // Reset translation when data changes
                setShowTranslation(false);
                setTranslatedTerm('');
            }, [data]);

            const handleTranslateClick = () => {
                if (showTranslation) {
                    setShowTranslation(false);
                } else {
                    t(data.transKey).then(text => {
                        setTranslatedTerm(text);
                        setShowTranslation(true);
                    });
                }
            };

            return (
                <div className="relative mt-2 p-4 rounded-lg shadow-lg border border-gray-200 bg-white" onClick={(e) => e.stopPropagation()}>
                    <p className="font-bold text-lg text-green-700 mb-2">
                        {data.term}
                        {showTranslation && translatedTerm && <span className="text-base text-gray-500 font-medium ml-2">({translatedTerm})</span>}
                    </p>
                    <div className="space-y-1">
                        <div className="text-gray-700" style={{fontSize: '16px', whiteSpace: 'pre-wrap'}}>{data.mainDef}</div>
                        {data.subTerms && (
                            <div className="mt-2 pt-2 border-t border-gray-200 text-sm text-gray-600 space-y-1">
                                {data.subTerms.map((sub, index) => (
                                    <p key={index}>â€¢ <strong className="text-gray-800">{sub.kor}</strong>: {sub.eng}</p>
                                ))}
                            </div>
                        )}
                        <button onClick={handleTranslateClick} className="text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-full transition duration-200 mt-1">
                             {showTranslation ? t_static('translation_hide_button_label') : t_static('translation_button_label')}
                        </button>
                    </div>
                    <button onClick={onClose} className="absolute top-1 right-1 text-gray-500 hover:text-gray-800 font-extrabold p-1 text-xl">&times;</button>
                </div>
            );
        };

        const SentenceChecker = ({ value, onChange, placeholder, question }) => { 
            const [feedback, setFeedback] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const checkSentence = async () => {
                if (!value || value.trim() === '') {
                    setError("ë¬¸ì¥ì„ ì…ë ¥í•´ì•¼ í”¼ë“œë°±ì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”.");
                    setFeedback(null);
                    return;
                }
                setIsLoading(true); setError(null); setFeedback(null);
                const prompt = `You are an advanced Korean language tutor AI for B1-C2 level learners. Analyze the user's sentence in response to a specific question. The user's answer is in Korean. Your entire response MUST be a JSON object, with all string values in Korean (ending in -ìš”) and English. Question: "${question}" User's Answer: "${value}" Your response MUST be a JSON object. 1.  **Relevance Check**: First, is the user's answer a relevant response to the question? * Set a boolean flag \`is_relevant\`. * If \`false\`, provide feedback in \`relevance_feedback_kor\` and \`relevance_feedback_eng\`. The rest of the fields can be null or empty arrays. 2.  **Grammar & Naturalness Check**: If the answer is relevant (\`is_relevant\` is \`true\`), check if it's grammatically correct and natural. * Set a boolean flag \`is_correct\`. 3.  **Generate Feedback based on Correctness**: * **If correct (\`is_correct\` is \`true\`):** * Provide a positive feedback message in \`feedback_message_kor\` and \`feedback_message_eng\`. * Provide 1-2 \`alternative_expressions\` to show different ways of saying the same thing. * **If incorrect (\`is_correct\` is \`false\`):** * Provide the \`corrected_sentence\`. * Provide a simple \`explanation_kor\` about what was corrected and why. * Provide the \`explanation_eng\`. * Provide 1-2 \`alternative_expressions\` for the *corrected* idea.`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "is_relevant": { "type": "BOOLEAN" }, "relevance_feedback_kor": { "type": "STRING", "nullable": true }, "relevance_feedback_eng": { "type": "STRING", "nullable": true }, "is_correct": { "type": "BOOLEAN", "nullable": true }, "feedback_message_kor": { "type": "STRING", "nullable": true }, "feedback_message_eng": { "type": "STRING", "nullable": true }, "corrected_sentence": { "type": "STRING", "nullable": true }, "explanation_kor": { "type": "STRING", "nullable": true }, "explanation_eng": { "type": "STRING", "nullable": true }, "alternative_expressions": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "expression_kor": { "type": "STRING" }, "expression_eng": { "type": "STRING" } }, "required": ["expression_kor", "expression_eng"] } } }, "required": ["is_relevant"] } } };
                const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const parsedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                        setFeedback(parsedJson);
                    } else { setError("AIì˜ ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”."); }
                } catch (err) { console.error("Error checking sentence:", err); setError("ë¬¸ì¥ ê²€ì‚¬ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
                } finally { setIsLoading(false); }
            };

            const renderFeedbackSection = (title, content) => ( content && content.length > 0 && ( <div> <p className="text-gray-800 font-bold" style={{ fontSize: '17px' }}>{title}</p> {Array.isArray(content) ? ( <ul className="list-disc list-inside space-y-2 mt-1"> {content.map((item, index) => ( <li key={index} className="text-gray-600" style={{ fontSize: '16px' }}> <p className="font-medium">{item.expression_kor || item.sentence_kor}</p> <p className="text-gray-500 italic text-sm">{item.expression_eng || item.sentence_eng}</p> </li> ))} </ul> ) : ( <p className="text-gray-700 font-medium" style={{ fontSize: '18px' }}>{content}</p> )} </div> ) );
            return ( <div> <textarea className="w-full p-3 border rounded-md focus:ring-2 focus:ring-green-400 transition text-lg" rows="3" placeholder={placeholder} value={value} onChange={onChange} /> <button onClick={checkSentence} disabled={isLoading} className="mt-3 flex items-center justify-center gap-2 bg-green-200 text-gray-900 py-2 px-4 rounded-md transition-colors hover:bg-green-300 disabled:opacity-50 disabled:cursor-wait" style={{ fontWeight: 600, fontSize: '14px' }} > {isLoading ? <Spinner className="w-5 h-5" /> : 'âœ¨'} {isLoading ? 'í”¼ë“œë°± ìƒì„± ì¤‘...' : 'AIì—ê²Œ í”¼ë“œë°± ë°›ê¸°'} </button> {error && <p className="mt-2 text-sm text-red-600">{error}</p>} {feedback && ( <div className="mt-4 p-4 bg-green-50 border-l-4 border-green-100 rounded-r-lg space-y-4"> {!feedback.is_relevant && ( <div> <p className="font-bold text-red-800 flex items-center gap-2 text-lg">{feedback.relevance_feedback_kor}</p> <p className="text-gray-600 italic">{feedback.relevance_feedback_eng}</p> </div> )} {feedback.is_relevant && feedback.is_correct && ( <div> <p className="font-bold text-green-800 flex items-center gap-2 text-lg"><ThumbsUp className="w-5 h-5"/> {feedback.feedback_message_kor}</p> <p className="text-gray-600 italic">{feedback.feedback_message_eng}</p> </div> )} {feedback.is_relevant && !feedback.is_correct && ( <> {feedback.corrected_sentence && ( <div> <p className="text-gray-800 font-bold" style={{ fontSize: '17px' }}>âœ¨ ìˆ˜ì •ëœ ë¬¸ì¥:</p> <p className="text-gray-700 font-medium" style={{ fontSize: '18px' }}>{feedback.corrected_sentence}</p> </div> )} {(feedback.explanation_kor || feedback.explanation_eng) && ( <div> <p className="text-gray-800 font-bold" style={{ fontSize: '17px' }}>ì„¤ëª…:</p> {feedback.explanation_kor && <p className="text-gray-600" style={{ fontSize: '16px' }}>{feedback.explanation_kor}</p>} {feedback.explanation_eng && <p className="text-gray-500 italic mt-1" style={{ fontSize: '15px' }}>{feedback.explanation_eng}</p>} </div> )} </> )} {feedback.alternative_expressions && feedback.alternative_expressions.length > 0 && renderFeedbackSection('ğŸ’¡ ë‹¤ë¥¸ í‘œí˜„:', feedback.alternative_expressions)} </div> )} </div> );
        };
        
        const DiscussionSection = () => {
            const [translationsVisible, setTranslationsVisible] = useState({});
            const [userQuestionAnswers, setUserQuestionAnswers] = useState({});

            const discussionQuestions = useMemo(() => [
                {
                    num: 1,
                    kor: "ì—¬ëŸ¬ë¶„ì€ ì˜¤ëŠ˜ ë­ í•´ìš”?",
                    eng: "What are you doing today?",
                    vocab: [
                        {
                            term: "ì˜¤ëŠ˜",
                            meaning: "today",
                            context: "ë¯¼í˜¸ ì”¨, ì˜¤ëŠ˜ ë­ í•´ìš”?",
                            context_eng: "Minho, what are you doing today?"
                        }
                    ]
                },
                {
                    num: 2,
                    kor: "ì—¬ëŸ¬ë¶„ì€ ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”? ì¹œêµ¬í•˜ê³  ë­ í•´ìš”?",
                    eng: "Do you meet friends? What do you do with your friends?",
                    vocab: [
                        {
                            term: "ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”",
                            meaning: "to meet a friend",
                            context: "ì €ëŠ” ì˜¤ëŠ˜ ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”.",
                            context_eng: "I'm meeting a friend today."
                        }
                    ]
                },
                {
                    num: 3,
                    kor: "ì—¬ëŸ¬ë¶„ì€ ì˜í™”ë¥¼ ë´ìš”? ì–´ë–¤ ì˜í™”ë¥¼ ë´ìš”?",
                    eng: "Do you watch movies? What movies do you watch?",
                    vocab: [
                        {
                            term: "ì˜í™”ë¥¼ ë´ìš”",
                            meaning: "to watch a movie",
                            context: "ê·¸ë¦¬ê³  ì˜í™”ë¥¼ ë´ìš”.",
                            context_eng: "And we're watching a movie."
                        }
                    ]
                },
                {
                    num: 4,
                    kor: "ì—¬ëŸ¬ë¶„ì€ ì§‘ì—ì„œ ì‰¬ì–´ìš”? ì§‘ì—ì„œ ë­ í•´ìš”?",
                    eng: "Do you rest at home? What do you do at home?",
                    vocab: [
                        {
                            term: "ì§‘ì—ì„œ ì‰¬ì–´ìš”",
                            meaning: "to rest at home",
                            context: "ì €ëŠ” ì˜¤ëŠ˜ ì§‘ì—ì„œ ì‰¬ì–´ìš”.",
                            context_eng: "I'm resting at home today."
                        }
                    ]
                },
                {
                    num: 5,
                    kor: "ì—¬ëŸ¬ë¶„ì€ ìŒì•…ì„ ë“¤ì–´ìš”? ì–´ë–¤ ìŒì•…ì„ ë“¤ì–´ìš”?",
                    eng: "Do you listen to music? What kind of music do you listen to?",
                    vocab: [
                        {
                            term: "ìŒì•…ì„ ë“¤ì–´ìš”",
                            meaning: "to listen to music",
                            context: "ì§‘ì—ì„œ ìŒì•…ì„ ë“¤ì–´ìš”.",
                            context_eng: "I listen to music at home."
                        }
                    ]
                },
                {
                    num: 6,
                    kor: "ì—¬ëŸ¬ë¶„ì€ ì±…ì„ ì½ì–´ìš”? ì–´ë–¤ ì±…ì„ ì½ì–´ìš”?",
                    eng: "Do you read books? What books do you read?",
                    vocab: [
                        {
                            term: "ì±…ì„ ì½ì–´ìš”",
                            meaning: "to read a book",
                            context: "ê·¸ë¦¬ê³  ì±…ì„ ì½ì–´ìš”.",
                            context_eng: "And I read books."
                        }
                    ]
                },
                {
                    num: 7,
                    kor: "ì—¬ëŸ¬ë¶„ì€ ë‚´ì¼ ë­ í•´ìš”? ë‚´ì¼ ì•½ì†ì´ ìˆì–´ìš”?",
                    eng: "What are you doing tomorrow? Do you have plans tomorrow?",
                    vocab: [
                        {
                            term: "ë‚´ì¼",
                            meaning: "tomorrow",
                            context: "ê·¸ëŸ¼ ë‚´ì¼ ë­ í•´ìš”?",
                            context_eng: "Then what are you doing tomorrow?"
                        },
                        {
                            term: "ì•½ì†ì´ ìˆì–´ìš”",
                            meaning: "I have plans",
                            context: "ë‚´ì¼ì€ ì•½ì†ì´ ìˆì–´ìš”.",
                            context_eng: "I have plans tomorrow."
                        }
                    ]
                },
                {
                    num: 8,
                    kor: "ì—¬ëŸ¬ë¶„ì€ ì˜·ì„ ì‚¬ìš”? ì–´ë””ì—ì„œ ì˜·ì„ ì‚¬ìš”?",
                    eng: "Do you buy clothes? Where do you buy clothes?",
                    vocab: [
                        {
                            term: "ì˜·ì„ ì‚¬ìš”",
                            meaning: "to buy clothes",
                            context: "ì˜·ì„ ì‚¬ìš”.",
                            context_eng: "I'm buying clothes."
                        }
                    ]
                },
                {
                    num: 9,
                    kor: "ì—¬ëŸ¬ë¶„ì€ ìš´ë™í•´ìš”? ì–´ë–¤ ìš´ë™ì„ í•´ìš”?",
                    eng: "Do you exercise? What kind of exercise do you do?",
                    vocab: [
                        {
                            term: "ìš´ë™í•´ìš”",
                            meaning: "to exercise",
                            context: "ì¼ìš”ì¼ì—ëŠ” ìš´ë™í•´ìš”.",
                            context_eng: "On Sundays, I exercise."
                        }
                    ]
                },
                {
                    num: 10,
                    kor: "ì—¬ëŸ¬ë¶„ì€ ìš”ë¦¬í•´ìš”? ê°€ë” ìš”ë¦¬í•´ìš”?",
                    eng: "Do you cook? Do you sometimes cook?",
                    vocab: [
                        {
                            term: "ìš”ë¦¬í•´ìš”",
                            meaning: "to cook",
                            context: "ê·¸ë¦¬ê³  ì €ë…ì—ëŠ” ì§‘ì—ì„œ ìš”ë¦¬í•´ìš”.",
                            context_eng: "And in the evening, I cook at home."
                        },
                        {
                            term: "ê°€ë”",
                            meaning: "sometimes",
                            context: "ì €ëŠ” ê°€ë” ìš”ë¦¬í•´ìš”.",
                            context_eng: "I cook sometimes."
                        }
                    ]
                }
            ], []);

            const toggleTranslation = (id) => {
                setTranslationsVisible(prev => ({ ...prev, [id]: !prev[id] }));
            };

            return (
                <section>
                    <h2 className="text-3xl font-extrabold text-gray-900 mb-6 pb-3 border-b-2 border-gray-300">ì—¬ëŸ¬ë¶„ì€ ì–´ë–»ê²Œ ìƒê°í•´ìš”? (What do you think?)</h2>
                    <div className="space-y-10">
                        {discussionQuestions.map((q) => (
                            <div key={q.num} className="p-6 border rounded-xl bg-white shadow-lg">
                                <p className="text-gray-900 text-xl font-bold">{q.num}. {q.kor}</p>
                                {translationsVisible[`q-${q.num}`] && (
                                    <p className="whitespace-pre-wrap text-gray-600 italic mt-1 text-base">{q.eng}</p>
                                )}
                                <button onClick={() => toggleTranslation(`q-${q.num}`)} className="text-xs text-gray-800 bg-gray-200 hover:bg-gray-300 font-bold py-1 px-3 rounded-full transition duration-200 mt-2 mb-6">
                                    ë²ˆì—­ (Translation)
                                </button>

                                {q.vocab && q.vocab.length > 0 && (
                                    <div className="mt-4 space-y-4">
                                        <h3 className="font-bold text-lg text-gray-800">ğŸ“í•µì‹¬ í‘œí˜„ (Essential phrases)</h3>
                                        {q.vocab.map((v, i) => (
                                            <div key={i} className="pl-4 border-l-2 border-gray-200 py-2">
                                                <p className="font-semibold text-blue-700 text-lg">{v.term}: <span className="font-medium text-gray-700 text-base">{v.meaning}</span></p>
                                                <div className="mt-2">
                                                    <h4 className="flex items-center gap-2 text-sm font-bold text-gray-600">
                                                        <span className="text-base">ğŸ’¬</span>
                                                        ëŒ€í™” ì†ì—ì„œ ì‚´í´ë³´ê¸° (See it in Context)
                                                    </h4>
                                                    <div className="mt-1 p-3 bg-gray-100 rounded-lg">
                                                        <p className="text-gray-800">"{v.context}"</p>
                                                        {translationsVisible[`q-${q.num}-context-${i}`] && (
                                                            <p className="text-gray-600 italic text-sm mt-1">{v.context_eng}</p>
                                                        )}
                                                        <button onClick={() => toggleTranslation(`q-${q.num}-context-${i}`)} className="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1 px-2 rounded-full transition duration-200 mt-2">
                                                            ë²ˆì—­ (Translation)
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                <div className="mt-6">
                                    <h3 className="font-bold text-lg text-gray-800 mb-2">í•µì‹¬ í‘œí˜„ì„ ì‚¬ìš©í•´ì„œ ì§ˆë¬¸ì— ëŒ€ë‹µí•´ ë³´ì„¸ìš”.</h3>
                                    <SentenceChecker
                                        value={userQuestionAnswers[`q-${q.num}`] || ''}
                                        onChange={(e) => setUserQuestionAnswers(prev => ({...prev, [`q-${q.num}`]: e.target.value}))}
                                        placeholder="ì—¬ê¸°ì— ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš” (Type your response here)"
                                        question={q.kor}
                                    />
                                </div>
                            </div>
                        ))}
                    </div>
                </section>
            );
        };

        const VocabItem = React.forwardRef(({ item, isHighlighted, t, t_static }, ref) => {
            const [exampleData, setExampleData] = useState(null); 
            const [isLoading, setIsLoading] = useState(false); 
            const [error, setError] = useState(null); 
            const [translatedTerm, setTranslatedTerm] = useState('');
            const [showTranslation, setShowTranslation] = useState(false);

            useEffect(() => {
                // Reset translation state when item changes
                setShowTranslation(false);
                setTranslatedTerm('');
            }, [item]);
            
            const handleTranslateClick = () => {
                if (showTranslation) {
                    setShowTranslation(false);
                } else {
                    setTranslatedTerm('...'); // Show loading indicator
                    t(item.transKey).then(text => {
                        setTranslatedTerm(text);
                        setShowTranslation(true);
                    });
                }
            };

            const generateExample = async () => {
                setIsLoading(true);
                setError(null);
                setExampleData(null);
                const prompt = `You are a Korean language teacher. Create two very easy, natural-sounding example sentences for a beginner learning the Korean term "${item.term}". The sentences MUST end with a polite '-ìš”' ending. Provide your response in the following JSON format, including English translations: { "examples": [ { "korean": "First Korean example sentence.", "english": "English translation." }, { "korean": "Second Korean example sentence.", "english": "English translation." } ] }`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "examples": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "korean": { "type": "STRING" }, "english": { "type": "STRING" } }, "required": ["korean", "english"] } } }, required: ["examples"] } } };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { throw new Error(`API error: ${response.status} ${response.statusText}`); }
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const parsedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                        setExampleData(parsedJson.examples);
                    } else { throw new Error("Invalid response structure from API."); }
                } catch (err) {
                    console.error("Error generating examples:", err);
                    setError("ì˜ˆë¬¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
                } finally {
                    setIsLoading(false);
                }
            };
           
            return (
                <div ref={ref} className={`leading-normal p-4 rounded-lg border-b border-gray-200 last:border-b-0 ${isHighlighted ? 'vocab-highlight' : 'hover:bg-gray-50'}`}>
                    <p className="font-bold text-green-700" style={{fontSize: '17px'}}>
                        {item.term}
                         {showTranslation && translatedTerm && <span className="text-gray-500 font-medium ml-2" style={{fontSize: '17px'}}>({translatedTerm})</span>}
                    </p>
                    <div className="pl-4 mt-2 space-y-1 border-l-2 border-gray-200">
                        <div className="text-gray-700" style={{fontSize: '16px', whiteSpace: 'pre-wrap'}}>{item.mainDef}</div>
                        {item.subTerms && (
                            <div className="mt-2 pt-2 border-t border-gray-200 text-sm text-gray-600 space-y-1">
                                {item.subTerms.map((sub, index) => (
                                    <p key={index}>â€¢ <strong className="text-gray-800">{sub.kor}</strong>: {sub.eng}</p>
                                ))}
                            </div>
                        )}
                    </div>
                    <div className="mt-3 flex items-center gap-2">
                          <button onClick={handleTranslateClick} className="bg-gray-200 hover:bg-gray-300 text-gray-800 py-1 px-3 rounded-full transition duration-200" style={{fontSize: '8pt', fontWeight: 400}}>
                            {showTranslation ? t_static('translation_hide_button_label') : t_static('translation_button_label')}
                          </button>
                          <button onClick={generateExample} disabled={isLoading} className="flex items-center gap-2 text-gray-900 bg-green-50 hover:bg-green-100 rounded-md px-3 py-1.5 transition-colors disabled:opacity-50 disabled:cursor-wait" style={{fontSize: '8pt', fontWeight: 400}}>
                            {isLoading ? <Spinner className="w-4 h-4" /> : <Sparkles className="w-4 h-4 text-green-600" />}
                            {isLoading ? 'ìƒì„± ì¤‘...' : 'Example'}
                        </button>
                    </div>
                    {error && <p className="mt-2 text-xs text-red-600">{error}</p>}
                    {exampleData && <div className="mt-3 p-3 bg-green-50 border-l-4 border-green-100 rounded-r-lg space-y-2">{exampleData.map((ex, i) => <div key={i}><p className="text-sm text-gray-800"><strong className="font-semibold text-gray-700">{`ì˜ˆë¬¸ ${i+1}:`}</strong> {ex.korean}</p><p className="text-sm text-gray-500 italic ml-4">{ex.english}</p></div>)}</div>}
                </div>
            );
        });
       
        const App = () => {
            const { t, lang, t_static } = useTranslation();
                       
            const scriptContent = useMemo(() => [
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's1-1', kor: 'ì•ˆë…•í•˜ì„¸ìš”.', eng: 'Hello.', start: 6.900, end: 8.204 },
                    { id: 's1-2', kor: '<ì‰¬ìš´ í•œêµ­ì–´ë¡œ ì´ì•¼ê¸°í•´ ë´ìš”> íŒŸìºìŠ¤íŠ¸ì˜ˆìš”.', eng: "This is the <Let's talk in easy Korean> podcast.", start: 8.204, end: 12.259 },
                    { id: 's1-3', kor: 'ì €ëŠ” ìœ ë‚˜ì˜ˆìš”.', eng: "I'm Yuna.", start: 12.259, end: 13.250 }
                ]},
                { speaker: 'ë¯¼í˜¸', lines: [
                    { id: 's2-1', kor: 'ì•ˆë…•í•˜ì„¸ìš”, ì €ëŠ” ë¯¼í˜¸ì˜ˆìš”.', eng: "Hello, I'm Minho.", start: 13.800, end: 16.286 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's3-1', kor: 'ë¯¼í˜¸ ì”¨, ì˜¤ëŠ˜ ë­ í•´ìš”?', eng: "Minho, what are you doing today?", start: 16.286, end: 18.335 },
                    { id: 's3-2', kor: "'ì˜¤ëŠ˜' means 'today'.", eng: "'ì˜¤ëŠ˜' means 'today'.", start: 18.335, end: 20.150 }
                ]},
                { speaker: 'ë¯¼í˜¸', lines: [
                    { id: 's4-1', kor: 'ì €ëŠ” ì˜¤ëŠ˜ ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”.', eng: "I'm meeting a friend today.", start: 20.587, end: 23.083 },
                    { id: 's4-2', kor: "'ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”' means 'to meet a friend'.", eng: "'ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”' means 'to meet a friend'.", start: 23.083, end: 26.546 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's5-1', kor: 'ì™€, ì¢‹ë„¤ìš”!', eng: "Wow, that's nice!", start: 26.546, end: 27.060 },
                    { id: 's5-2', kor: 'ì¹œêµ¬í•˜ê³  ë­ í•´ìš”?', eng: "What are you doing with your friend?", start: 28.141, end: 29.700 }
                ]},
                { speaker: 'ë¯¼í˜¸', lines: [
                    { id: 's6-1', kor: 'ê°™ì´ í”¼ìë¥¼ ë¨¹ì–´ìš”.', eng: "We're eating pizza together.", start: 29.700, end: 31.740 },
                    { id: 's6-2', kor: 'ê·¸ë¦¬ê³  ì˜í™”ë¥¼ ë´ìš”.', eng: "And we're watching a movie.", start: 31.740, end: 33.865 },
                    { id: 's6-3', kor: "'ì˜í™”ë¥¼ ë´ìš”' means 'to watch a movie'.", eng: "'ì˜í™”ë¥¼ ë´ìš”' means 'to watch a movie'.", start: 33.865, end: 36.736 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's7-1', kor: 'ì˜í™”ìš”?', eng: "A movie?", start: 36.736, end: 38.110 },
                    { id: 's7-2', kor: "ì¬ë¯¸ìˆê² ë„¤ìš”! It means, 'That sounds fun!'", eng: "ì¬ë¯¸ìˆê² ë„¤ìš”! It means, 'That sounds fun!'", start: 38.110, end: 42.724 },
                    { id: 's7-3', kor: 'ì €ë„ ì˜í™” ì¢‹ì•„í•´ìš”.', eng: "I like movies too.", start: 42.724, end: 45.924 }
                ]},
                { speaker: 'ë¯¼í˜¸', lines: [
                    { id: 's8-1', kor: 'ìœ ë‚˜ ì”¨ëŠ” ì˜¤ëŠ˜ ë­ í•´ìš”?', eng: "Yuna, what are you doing today?", start: 45.924, end: 48.127 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's9-1', kor: 'ì €ëŠ” ì˜¤ëŠ˜ ì§‘ì—ì„œ ì‰¬ì–´ìš”.', eng: "I'm resting at home today.", start: 48.127, end: 51.702 },
                    { id: 's9-2', kor: "'ì§‘ì—ì„œ ì‰¬ì–´ìš”' means 'to rest at home'.", eng: "'ì§‘ì—ì„œ ì‰¬ì–´ìš”' means 'to rest at home'.", start: 51.702, end: 55.530 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's9-3', kor: 'ì§‘ì—ì„œ ìŒì•…ì„ ë“¤ì–´ìš”.', eng: "I listen to music at home.", start: 55.530, end: 58.444 },
                    { id: 's9-4', kor: "'ìŒì•…ì„ ë“¤ì–´ìš”' means 'to listen to music'.", eng: "'ìŒì•…ì„ ë“¤ì–´ìš”' means 'to listen to music'.", start: 58.444, end: 62.236 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's9-5', kor: 'ê·¸ë¦¬ê³  ì±…ì„ ì½ì–´ìš”.', eng: "And I read books.", start: 62.236, end: 64.719 },
                    { id: 's9-6', kor: "'ì±…ì„ ì½ì–´ìš”' means 'to read a book'.", eng: "'ì±…ì„ ì½ì–´ìš”' means 'to read a book'.", start: 64.719, end: 67.869 }
                ]},
                { speaker: 'ë¯¼í˜¸', lines: [
                    { id: 's10-1', kor: 'ê·¸ëŸ¼ ë‚´ì¼ ë­ í•´ìš”?', eng: "Then what are you doing tomorrow?", start: 67.869, end: 70.297 },
                    { id: 's10-2', kor: "'ë‚´ì¼' means 'tomorrow'.", eng: "'ë‚´ì¼' means 'tomorrow'.", start: 70.297, end: 72.524 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's11-1', kor: 'ë‚´ì¼ì€ ì•½ì†ì´ ìˆì–´ìš”.', eng: "I have plans tomorrow.", start: 72.524, end: 74.700 },
                    { id: 's11-2', kor: "'ì•½ì†ì´ ìˆì–´ìš”' means 'I have plans'.", eng: "'ì•½ì†ì´ ìˆì–´ìš”' means 'I have plans'.", start: 74.700, end: 78.348 },
                    { id: 's11-3', kor: 'ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”.', eng: "I'm meeting a friend.", start: 78.348, end: 80.334 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's11-4', kor: 'ê·¸ë¦¬ê³  ì‡¼í•‘ëª°ì— ê°€ìš”.', eng: "And I'm going to the shopping mall.", start: 80.334, end: 82.976 },
                    { id: 's11-5', kor: 'ì˜·ì„ ì‚¬ìš”.', eng: "I'm buying clothes.", start: 82.976, end: 84.714 },
                    { id: 's11-6', kor: "'ì˜·ì„ ì‚¬ìš”' means 'to buy clothes'.", eng: "'ì˜·ì„ ì‚¬ìš”' means 'to buy clothes'.", start: 84.714, end: 87.855 }
                ]},
                { speaker: 'ë¯¼í˜¸', lines: [
                    { id: 's12-1', kor: 'ì‡¼í•‘í•˜ë„¤ìš”. Oh, so you\'re shopping.', eng: 'Oh, so you\'re shopping.', start: 87.855, end: 90.572 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's13-1', kor: 'ë§ì•„ìš”. ë¯¼í˜¸ ì”¨ëŠ” ì¼ìš”ì¼ì—ëŠ” ë­ í•´ìš”?', eng: "That's right. Minho, what do you do on Sundays?", start: 90.572, end: 94.824 }
                ]},
                { speaker: 'ë¯¼í˜¸', lines: [
                    { id: 's14-1', kor: 'ì¼ìš”ì¼ì—ëŠ” ìš´ë™í•´ìš”.', eng: "On Sundays, I exercise.", start: 94.824, end: 96.890 },
                    { id: 's14-2', kor: 'ê·¸ë¦¬ê³  ì €ë…ì—ëŠ” ì§‘ì—ì„œ ìš”ë¦¬í•´ìš”.', eng: "And in the evening, I cook at home.", start: 96.890, end: 100.000 },
                    { id: 's14-3', kor: "'ìš”ë¦¬í•´ìš”' means 'to cook'.", eng: "'ìš”ë¦¬í•´ìš”' means 'to cook'.", start: 100.000, end: 102.111 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's15-1', kor: 'ì •ë§ìš”? ë¯¼í˜¸ ì”¨ê°€ ìš”ë¦¬í•´ìš”?', eng: "Really? You cook, Minho?", start: 102.431, end: 105.666 }
                ]},
                { speaker: 'ë¯¼í˜¸', lines: [
                    { id: 's16-1', kor: 'ë„¤, ì €ëŠ” ì§‘ì—ì„œ ìš”ë¦¬ë¥¼ í•´ìš”.', eng: "Yes, I cook at home.", start: 105.666, end: 108.111 },
                    { id: 's16-2', kor: 'ìœ ë‚˜ ì”¨ëŠ”ìš”?', eng: "How about you, Yuna?", start: 108.428, end: 109.545 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's17-1', kor: 'ì €ëŠ” ê°€ë” ìš”ë¦¬í•´ìš”.', eng: "I cook sometimes.", start: 109.545, end: 112.500 },
                    { id: 's17-2', kor: "'ê°€ë”' means 'sometimes'.", eng: "'ê°€ë”' means 'sometimes'.", start: 112.500, end: 115.324 }
                ]},
                { speaker: 'ë¯¼í˜¸', lines: [
                    { id: 's18-1', kor: 'ê·¸ë ‡êµ°ìš”. Okay then.', eng: 'Okay then.', start: 115.324, end: 117.486 },
                    { id: 's18-2', kor: 'ê·¸ëŸ¼ ì˜¤ëŠ˜ ë°°ìš´ í‘œí˜„ë“¤ì„ ë‹¤ì‹œ í™•ì¸í•´ ë³¼ê¹Œìš”? \n Shall we review the expressions we learned today?', eng: 'Shall we review the expressions we learned today?', start: 117.486, end: 123.080 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's19-1', kor: 'ì¢‹ì•„ìš”!', eng: "Good!", start: 123.334, end: 124.641 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's19-2', kor: 'â€¢ ì˜¤ëŠ˜: today', eng: 'â€¢ ì˜¤ëŠ˜: today', start: 125.531, end: 128.134 },
                    { id: 's19-3', kor: 'â€¢ ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”: to meet a friend', eng: 'â€¢ ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”: to meet a friend', start: 128.134, end: 133.407 },
                    { id: 's19-4', kor: 'â€¢ ì˜í™”ë¥¼ ë´ìš”: to watch a movie', eng: 'â€¢ ì˜í™”ë¥¼ ë´ìš”: to watch a movie', start: 133.407, end: 137.669 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's19-5', kor: 'â€¢ ì§‘ì—ì„œ ì‰¬ì–´ìš”: to rest at home', eng: 'â€¢ ì§‘ì—ì„œ ì‰¬ì–´ìš”: to rest at home', start: 137.669, end: 141.971 },
                    { id: 's19-6', kor: 'â€¢ ìŒì•…ì„ ë“¤ì–´ìš”: to listen to music', eng: 'â€¢ ìŒì•…ì„ ë“¤ì–´ìš”: to listen to music', start: 141.971, end: 146.296 },
                    { id: 's19-7', kor: 'â€¢ ì±…ì„ ì½ì–´ìš”: to read a book', eng: 'â€¢ ì±…ì„ ì½ì–´ìš”: to read a book', start: 146.296, end: 150.366 }
                ]},
                { speaker: 'ë¯¼í˜¸', lines: [
                    { id: 's20-1', kor: 'â€¢ ë‚´ì¼: tomorrow', eng: 'â€¢ ë‚´ì¼: tomorrow', start: 150.666, end: 152.927 },
                    { id: 's20-2', kor: 'â€¢ ì•½ì†ì´ ìˆì–´ìš”: I have plans', eng: 'â€¢ ì•½ì†ì´ ìˆì–´ìš”: I have plans', start: 152.927, end: 156.572 },
                    { id: 's20-3', kor: 'â€¢ ì˜·ì„ ì‚¬ìš”: to buy clothes', eng: 'â€¢ ì˜·ì„ ì‚¬ìš”: to buy clothes', start: 156.572, end: 159.572 }
                ]},
                { speaker: 'ë¯¼í˜¸', lines: [
                    { id: 's20-4', kor: 'â€¢ ìš´ë™í•´ìš”: to exercise', eng: 'â€¢ ìš´ë™í•´ìš”: to exercise', start: 159.572, end: 162.558 },
                    { id: 's20-5', kor: 'â€¢ ìš”ë¦¬í•´ìš”: to cook', eng: 'â€¢ ìš”ë¦¬í•´ìš”: to cook', start: 162.558, end: 165.200 },
                    { id: 's20-6', kor: 'â€¢ ê°€ë”: sometimes', eng: 'â€¢ ê°€ë”: sometimes', start: 165.200, end: 167.535 }
                ]},
                { speaker: 'ìœ ë‚˜', lines: [
                    { id: 's21-1', kor: 'ì˜¤ëŠ˜ì€ ì—¬ê¸°ê¹Œì§€ì˜ˆìš”. That\'s all for today.', eng: 'That\'s all for today.', start: 168.145, end: 172.089 },
                    { id: 's21-2', kor: 'ì•ˆë…•íˆ ê³„ì„¸ìš”.', eng: 'Goodbye.', start: 172.389, end: 173.800 }
                ]},
                { speaker: 'ë¯¼í˜¸', lines: [
                    { id: 's22-1', kor: 'ì•ˆë…•íˆ ê³„ì„¸ìš”. ë‹¤ìŒì— ë§Œë‚˜ìš”.', eng: 'Goodbye. See you next time.', start: 174.000, end: 176.349 }
                ]}
            ], []);
           
            const vocabAndGrammarList = useMemo(() => [
                { term: 'ì‰¬ìš´ í•œêµ­ì–´ë¡œ ì´ì•¼ê¸°í•´ ë´ìš”', mainDef: 'Let\'s talk in easy Korean', subTerms: [{ kor: 'ì‰¬ìš´', eng: 'easy' }, { kor: 'í•œêµ­ì–´ë¡œ', eng: 'in Korean' }, { kor: 'ì´ì•¼ê¸°í•˜ë‹¤', eng: 'to talk' }, { kor: '-ì•„/ì–´ ë³´ë‹¤', eng: 'used to make gentle suggestions without sounding pushy' }], transKey: 'term_trans_easy_korean' },
                { term: 'íŒŸìºìŠ¤íŠ¸', mainDef: 'podcast', transKey: 'term_trans_podcast' },
                { term: 'ì˜¤ëŠ˜', mainDef: 'today', transKey: 'term_trans_today' },
                { term: 'ë­ í•´ìš”?', mainDef: 'What are you doing?', subTerms: [{ kor: 'ë­', eng: 'what' }, { kor: 'í•´ìš”', eng: 'to do' }], transKey: 'term_trans_what_are_you_doing' },
                { term: 'ì¹œêµ¬ë¥¼ ë§Œë‚˜ìš”', mainDef: 'to meet a friend', subTerms: [{ kor: 'ì¹œêµ¬', eng: 'friend' }, { kor: 'ë§Œë‚˜ìš”', eng: 'to meet' }], transKey: 'term_trans_meet_friend' },
                { term: 'ê°™ì´', mainDef: 'together', transKey: 'term_trans_together' },
                { term: 'ë¨¹ì–´ìš”', mainDef: 'to eat', transKey: 'term_trans_eat' },
                { term: 'ì˜í™”ë¥¼ ë´ìš”', mainDef: 'to watch a movie', subTerms: [{ kor: 'ì˜í™”', eng: 'movie' }, { kor: 'ë´ìš”', eng: 'to watch' }], transKey: 'term_trans_watch_movie' },
                { term: 'ì¬ë¯¸ìˆê² ë„¤ìš”', mainDef: 'That sounds fun!', subTerms: [{ kor: 'ì¬ë¯¸ìˆì–´ìš”', eng: 'to be fun, interesting' }, { kor: '-ë„¤ìš”', eng: 'ending to show reaction or realization' }], transKey: 'term_trans_sounds_fun' },
                { term: 'ì €ë„', mainDef: 'me too / I also', transKey: 'term_trans_me_too' },
                { term: 'ì¢‹ì•„í•´ìš”', mainDef: 'to like', transKey: 'term_trans_like' },
                { term: 'ì§‘ì—ì„œ', mainDef: 'at home', subTerms: [{ kor: 'ì§‘', eng: 'home' }, { kor: '-ì—ì„œ', eng: 'particle indicating location of action' }], transKey: 'term_trans_at_home' },
                { term: 'ì‰¬ì–´ìš”', mainDef: 'to rest', transKey: 'term_trans_rest' },
                { term: 'ìŒì•…ì„ ë“¤ì–´ìš”', mainDef: 'to listen to music', subTerms: [{ kor: 'ìŒì•…', eng: 'music' }, { kor: 'ë“¤ì–´ìš”', eng: 'to listen' }], transKey: 'term_trans_listen_music' },
                { term: 'ì±…ì„ ì½ì–´ìš”', mainDef: 'to read a book', subTerms: [{ kor: 'ì±…', eng: 'book' }, { kor: 'ì½ì–´ìš”', eng: 'to read' }], transKey: 'term_trans_read_book' },
                { term: 'ë‚´ì¼', mainDef: 'tomorrow', transKey: 'term_trans_tomorrow' },
                { term: 'ì•½ì†ì´ ìˆì–´ìš”', mainDef: 'I have plans / an appointment', subTerms: [{ kor: 'ì•½ì†', eng: 'promise, plan, appointment' }], transKey: 'term_trans_have_plans' },
                { term: 'ì‡¼í•‘ëª°ì— ê°€ìš”', mainDef: 'to go to the shopping mall', subTerms: [{ kor: 'ì‡¼í•‘ëª°', eng: 'shopping mall' }, { kor: '-ì—', eng: 'to (location)' }, { kor: 'ê°€ìš”', eng: 'to go' }], transKey: 'term_trans_go_shopping_mall' },
                { term: 'ì˜·ì„ ì‚¬ìš”', mainDef: 'to buy clothes', subTerms: [{ kor: 'ì˜·', eng: 'clothes' }, { kor: 'ì‚¬ìš”', eng: 'to buy' }], transKey: 'term_trans_buy_clothes' },
                { term: 'ì‡¼í•‘í•˜ë„¤ìš”', mainDef: 'Oh, you are shopping.', subTerms: [{ kor: 'ì‡¼í•‘í•˜ë‹¤', eng: 'to shop' }, { kor: '-ë„¤ìš”', eng: 'showing realization or surprise' }], transKey: 'term_trans_are_shopping' },
                { term: 'ë§ì•„ìš”', mainDef: "that's right", transKey: 'term_trans_thats_right' },
                { term: 'ì¼ìš”ì¼ì—ëŠ”', mainDef: 'on Sunday', subTerms: [{ kor: 'ì¼ìš”ì¼', eng: 'Sunday' }, { kor: '-ì—', eng: 'on (time marker)' }], transKey: 'term_trans_on_sunday' },
                { term: 'ì €ë…ì—ëŠ”', mainDef: 'in the evening', subTerms: [{ kor: 'ì €ë…', eng: 'evening' }, { kor: '-ì—', eng: 'at, in (time marker)' }], transKey: 'term_trans_in_evening' },
                { term: 'ìš”ë¦¬í•´ìš”', mainDef: 'to cook', transKey: 'term_trans_cook' },
                { term: 'ì •ë§ìš”?', mainDef: 'Really?', transKey: 'term_trans_really' },
                { term: 'ìš”ë¦¬ë¥¼ í•´ìš”', mainDef: 'to cook (something)', subTerms: [{ kor: 'ìš”ë¦¬', eng: 'cooking, dish' }, { kor: 'í•´ìš”', eng: 'to do' }], transKey: 'term_trans_cook_something' },
                { term: 'ê°€ë”', mainDef: 'sometimes', transKey: 'term_trans_sometimes' },
                { term: 'ê·¸ë ‡êµ°ìš”', mainDef: 'I see / Oh, I get it', transKey: 'term_trans_i_see' },
                { term: 'ë°°ìš´ í‘œí˜„ë“¤', mainDef: 'the expressions (we) learned', transKey: 'term_trans_expressions_learned' },
                { term: 'ë‹¤ì‹œ', mainDef: 'again', transKey: 'term_trans_again' },
                { term: 'í™•ì¸í•´ ë³¼ê¹Œìš”?', mainDef: 'Shall we check/confirm?', subTerms: [{ kor: 'í™•ì¸í•˜ë‹¤', eng: 'to check, confirm' }, { kor: '-ì•„/ì–´ ë³¼ê¹Œìš”?', eng: 'Shall we try... ? (polite suggestion)' }], transKey: 'term_trans_shall_we_check' },
                { term: 'ì—¬ê¸°ê¹Œì§€ì˜ˆìš”', mainDef: "That's all (for now).", subTerms: [{ kor: 'ì—¬ê¸°', eng: 'here' }, { kor: 'ê¹Œì§€', eng: 'until, up to' }], transKey: 'term_trans_thats_all' }
            ], []);
           
            const [activeTab, setActiveTab] = useState('script');
            const [translationsVisible, setTranslationsVisible] = useState({});
            const [inlinePopupData, setInlinePopupData] = useState(null);
            const [activeWordId, setActiveWordId] = useState(null);
            const [highlightedVocab, setHighlightedVocab] = useState(null);
            const vocabRefs = useRef({});
            const scriptLineRefs = useRef({});
            const scriptBlockRefs = useRef({});
            const [player, setPlayer] = useState(null);
            const [activeScriptLine, setActiveScriptLine] = useState(null);
            const [isSyncEnabled, setIsSyncEnabled] = useState(true);
            const [isVocabSidebarVisible, setIsVocabSidebarVisible] = useState(true);
            const [repeatingLine, setRepeatingLine] = useState(null);
            const intervalRef = useRef();
            const playerContainerRef = useRef(null);
            const [playerHeight, setPlayerHeight] = useState(0);
            const vocabContainerRef = useRef(null);

            const toggleTranslation = useCallback((id) => {
                setTranslationsVisible(prev => ({ ...prev, [id]: !prev[id] }));
            }, []);

            useEffect(() => {
                let ro;
                if (activeTab === 'script' && playerContainerRef.current) {
                    const updateHeight = () => playerContainerRef.current && setPlayerHeight(playerContainerRef.current.offsetHeight);
                    ro = new ResizeObserver(updateHeight);
                    ro.observe(playerContainerRef.current);
                    updateHeight();
                }
                return () => ro?.disconnect();
            }, [activeTab]);

            const allScriptLines = useMemo(() => scriptContent.flatMap(block => block.lines), [scriptContent]);
            const onPlayerReady = (event) => setPlayer(event.target);
            const setupPlayer = useCallback(() => {
                if (window.YT && window.YT.Player) {
                    new window.YT.Player('youtube-player', { videoId: 'dvs7VQb-b3U', width: '100%', height: '100%', events: { 'onReady': onPlayerReady } });
                }
            }, []);

            useEffect(() => {
                if (!window.YT) {
                    window.onYouTubeIframeAPIReady = setupPlayer;
                } else {
                    setupPlayer();
                }
                return () => { if (intervalRef.current) clearInterval(intervalRef.current); };
            }, [setupPlayer]);

            useEffect(() => {
                if (player && isSyncEnabled && !repeatingLine) {
                    intervalRef.current = setInterval(() => {
                        const currentTime = player.getCurrentTime();
                        const currentLine = allScriptLines.find(line => currentTime >= line.start && currentTime < line.end);
                        setActiveScriptLine(currentLine ? currentLine.id : null);
                    }, 250);
                } else {
                    clearInterval(intervalRef.current);
                }
                return () => clearInterval(intervalRef.current);
            }, [player, isSyncEnabled, allScriptLines, repeatingLine]);

            useEffect(() => {
                if (activeScriptLine && isSyncEnabled && !repeatingLine && !inlinePopupData) {
                    const activeBlock = scriptContent.find(block => block.lines.some(line => line.id === activeScriptLine));
                    if (activeBlock) {
                        const blockKey = activeBlock.lines[0].id;
                        const blockElement = scriptBlockRefs.current[blockKey];
                        if (blockElement) {
                            const gapInPixels = 19; // 0.5cm
                            const blockTop = blockElement.getBoundingClientRect().top;
                            const scrollAmount = blockTop - (playerHeight + gapInPixels);
                            window.scrollBy({ top: scrollAmount, behavior: 'smooth' });
                        }
                    }
                }
            }, [activeScriptLine, isSyncEnabled, repeatingLine, playerHeight, scriptContent, inlinePopupData]);

            useEffect(() => {
                if (repeatingLine && player) {
                    const { start, end } = repeatingLine;
                    player.seekTo(start); player.playVideo();
                    intervalRef.current = setInterval(() => { if (player.getCurrentTime() >= end) { player.seekTo(start); } }, 200);
                } else {
                    clearInterval(intervalRef.current);
                }
                return () => clearInterval(intervalRef.current);
            }, [repeatingLine, player]);

            const handleRepeatClick = (line) => {
                 if (repeatingLine && repeatingLine.id === line.id) {
                    setRepeatingLine(null); 
                    player.pauseVideo();
                } else {
                    setRepeatingLine({id: line.id, start: line.start, end: line.end});
                }
            };

            const vocabMap = useMemo(() => new Map(vocabAndGrammarList.map(item => [item.term, item])), [vocabAndGrammarList]);
            const highlightableWords = useMemo(() => Array.from(vocabMap.keys()).sort((a, b) => b.length - a.length), [vocabMap]);
           
            const handleClosePopup = () => {
                setInlinePopupData(null);
                setActiveWordId(null);
                setHighlightedVocab(null);
            };

            useEffect(() => {
                window.addEventListener('click', handleClosePopup);
                return () => window.removeEventListener('click', handleClosePopup);
            }, []);
           
            const handleWordClick = (e, word, lineId, partIndex) => {
                e.stopPropagation();
                const uniqueWordId = `${lineId}-${partIndex}-${word}`;
                const wordData = vocabMap.get(word.trim());

                if (wordData) {
                    if (activeWordId === uniqueWordId) {
                        handleClosePopup();
                    } else {
                        setActiveWordId(uniqueWordId);
                        setInlinePopupData({ lineId: lineId, data: wordData });
                        setHighlightedVocab(wordData.term);
                       
                        const vocabElement = vocabRefs.current[wordData.term];
                        const vocabContainer = vocabContainerRef.current;
                        if (vocabElement && vocabContainer) {
                            const offset = 19; // 0.5cm
                            vocabContainer.scrollTo({ top: vocabElement.offsetTop - offset, behavior: 'smooth' });
                        }
                    }
                }
            };

            useEffect(() => {
                if (inlinePopupData) {
                    const lineElement = scriptLineRefs.current[inlinePopupData.lineId];
                    const playerEl = playerContainerRef.current;
                    if (lineElement && playerEl) {
                        const offset = 19; // 0.5cm
                        const playerBottom = playerEl.getBoundingClientRect().bottom;
                        const lineTop = lineElement.getBoundingClientRect().top;
                       
                        // Check if the line is already in the correct position
                        const currentGap = lineTop - playerBottom;
                        if (Math.abs(currentGap - offset) > 1) { // Add a small tolerance
                            const scrollByY = lineTop - playerBottom - offset;
                            window.scrollBy({ top: scrollByY, behavior: 'smooth' });
                        }
                    }
                }
            }, [inlinePopupData]);

            const HighlightedText = ({ text, words, onWordClick, lineId, activeWordId }) => {
                if (!words.length) return text;
                const regex = new RegExp(`(${words.map(w => w.replace(/[.*+?^${}()|[\\\\\\]]/g, '\\\\$&')).join('|')})`, 'g');
                return (<>{text.split(regex).map((part, index) => {
                    const isWord = words.includes(part);
                    if (!isWord) return part;
                    const uniqueWordId = `${lineId}-${index}-${part}`;
                    let className = 'highlight-general';
                    if (activeWordId === uniqueWordId) className += ' active-highlight';
                    return <span key={index} className={className} onClick={(e) => onWordClick(e, part, lineId, index)}>{part}</span>;
                })}</>);
            };

            const tabs = [
                { id: 'script', kor: 'ëŒ€í™” ìŠ¤í¬ë¦½íŠ¸', eng: '(Transcript)' },
                { id: 'quiz', kor: 'ë‚´ìš© í™•ì¸ í€´ì¦ˆ', eng: '(Comprehension Quiz)' },
                { id: 'practice', kor: 'ì—¬ëŸ¬ë¶„ì€ ì–´ë–»ê²Œ ìƒê°í•´ìš”?', eng: '(What do you think?)' }
            ];
           
            return (
                <div className="bg-gray-50 text-gray-800 p-4 sm:p-6 md:p-8">
                    <div className="main-content-container">
                        <header className="text-center mb-4">
                            <h1 className="text-3xl font-black text-gray-900 mb-2">ì‰¬ìš´ í•œêµ­ì–´ë¡œ ì´ì•¼ê¸°í•´ ë´ìš”</h1>
                            <p className="text-lg text-gray-500">[íŒŸìºìŠ¤íŠ¸] ì˜¤ëŠ˜ ë­ í•´ìš”?</p>
                        </header>
                       
                        {activeTab === 'script' && <div ref={playerContainerRef} className="sticky top-4 z-20 mb-4"><div className="w-full rounded-xl shadow-xl overflow-hidden aspect-video border-4 border-white"><div id="youtube-player"></div></div></div>}

                        <div className="bg-white rounded-xl shadow-lg p-2 sm:p-4">
                            <div className="border-b border-gray-200">
                                <nav className="-mb-px flex flex-wrap gap-x-4 sm:gap-x-6">
                                    {tabs.map(tab => (
                                        <button 
                                            key={tab.id} 
                                            onClick={() => setActiveTab(tab.id)} 
                                            className={`${activeTab === tab.id ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-bold transition-colors`}
                                        >
                                            <span className="text-sm sm:text-base">{tab.kor}</span>
                                            <span className="text-[10px] sm:text-xs ml-1">{tab.eng}</span>
                                        </button>
                                    ))}
                                </nav>
                            </div>
                            <div className="py-6">
                                {activeTab === 'script' && (
                                    <div className="flex flex-col md:flex-row gap-6">
                                        <div className="flex-grow">
                                            <div className="space-y-6 px-2 sm:px-4">{scriptContent.map((block, blockIndex) => <div key={`${block.speaker}-${blockIndex}`} ref={el => scriptBlockRefs.current[block.lines[0].id] = el} className="leading-relaxed"><p className="font-extrabold text-green-700 text-xl">{block.speaker}</p><div className="pl-4 border-l-4 border-gray-200 mt-2 space-y-2">{block.lines.map(line => <div key={line.id}><div ref={el => scriptLineRefs.current[line.id] = el} className={`p-2 ${activeScriptLine === line.id && !inlinePopupData ? 'script-highlight' : ''}`}><p className="whitespace-pre-wrap text-xl text-gray-900 font-medium"><HighlightedText text={line.kor} words={highlightableWords} onWordClick={handleWordClick} lineId={line.id} activeWordId={activeWordId}/></p>{translationsVisible[line.id] && <p className="whitespace-pre-wrap text-gray-600 italic mt-1 text-base">{line.eng}</p>}<div className="flex items-center gap-2 mt-2"><button onClick={() => toggleTranslation(line.id)} className="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-1 px-4 rounded-full transition duration-200" style={{fontSize: '10px'}}>ë²ˆì—­ (Translation)</button><button onClick={() => handleRepeatClick(line)} className={`${repeatingLine?.id === line.id ? 'bg-green-500 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-700'} font-medium py-1 px-4 rounded-full transition duration-200`} style={{fontSize: '10px'}}>{repeatingLine?.id === line.id ? 'ë°˜ë³µ ì¤‘' : 'êµ¬ê°„ ë°˜ë³µ (A-B Repeat)'}</button></div></div>{inlinePopupData?.lineId === line.id && <InlineDefinition data={inlinePopupData.data} onClose={handleClosePopup} t={t} t_static={t_static} />}</div>)}</div></div>)}</div>
                                        </div>
                                        <div className="w-full md:w-auto flex-shrink-0">
                                            <div className="sticky z-10" style={{ top: playerHeight ? `${playerHeight + 32}px` : '40vh' }}>
                                                <div className="flex flex-row items-stretch gap-2 mb-2" style={{ maxWidth: '7cm' }}>
                                                    <label htmlFor="sync-toggle" className="flex-1 flex items-center justify-between cursor-pointer bg-white py-1.5 px-2 rounded-lg shadow-md border"><span className="text-xs font-medium text-gray-900 whitespace-nowrap">ìë™ ìŠ¤í¬ë¡¤</span><div className="relative w-10" style={{height: '0.3cm'}}><input type="checkbox" id="sync-toggle" className="sr-only" checked={isSyncEnabled} onChange={() => setIsSyncEnabled(!isSyncEnabled)}/><div className={`block w-full h-full rounded-full transition-colors ${isSyncEnabled ? 'bg-green-500' : 'bg-gray-200'}`}></div><div className={`dot absolute bg-white rounded-full transition-transform transform`} style={{height: 'calc(0.3cm - 4px)', width: 'calc(0.3cm - 4px)', top: '2px', left: '2px', transform: isSyncEnabled ? 'translateX(calc(2.5rem - 0.3cm))' : 'translateX(0px)' }}></div></div></label>
                                                    <label htmlFor="vocab-toggle" className="flex-1 flex items-center justify-between cursor-pointer bg-white py-1.5 px-2 rounded-lg shadow-md border"><span className="text-xs font-medium text-gray-900 whitespace-nowrap">í•µì‹¬ ì–´íœ˜ ëª©ë¡</span><div className="relative w-10" style={{height: '0.3cm'}}><input type="checkbox" id="vocab-toggle" className="sr-only" checked={isVocabSidebarVisible} onChange={() => setIsVocabSidebarVisible(!isVocabSidebarVisible)}/><div className={`block w-full h-full rounded-full transition-colors ${isVocabSidebarVisible ? 'bg-green-500' : 'bg-gray-200'}`}></div><div className={`dot absolute bg-white rounded-full transition-transform transform`} style={{height: 'calc(0.3cm - 4px)', width: 'calc(0.3cm - 4px)', top: '2px', left: '2px', transform: isVocabSidebarVisible ? 'translateX(calc(2.5rem - 0.3cm))' : 'translateX(0px)'}}></div></div></label>
                                                </div>
                                                {isVocabSidebarVisible && <aside ref={vocabContainerRef} className="w-full max-h-[calc(100vh-450px)] overflow-y-auto" style={{maxWidth: '7cm'}}><div className="border rounded-lg bg-white p-2 shadow-lg"><div className="space-y-1">{vocabAndGrammarList.map(item => <VocabItem key={item.term} item={item} ref={el => vocabRefs.current[item.term] = el} isHighlighted={highlightedVocab === item.term} t={t} t_static={t_static}/>)}</div></div></aside>}
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {activeTab === 'quiz' && <ComprehensionQuiz />}
                                {activeTab === 'practice' && <DiscussionSection />}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
       
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
